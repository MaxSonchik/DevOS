name: Build DevOS Packages and ISO

on:
  push:
    branches: [ "main" ]
    paths:
      - 'packages/**'
      - 'archiso/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build ISO with Custom Packages
        run: |
          set -e 

          echo "--- Preparing Environment ---"
          pacman -Syu --noconfirm base-devel git archiso
          useradd builder -m
          echo 'builder ALL=(ALL) NOPASSWD: /usr/bin/pacman' >> /etc/sudoers
          mkdir -p /data/repo
          chown -R builder:builder /data

          su builder -c '
            cd /data/packages && \
            echo "--- Building all custom packages ---" && \
            for dir in */ ; do
              if [ -f "${dir}PKGBUILD" ]; then
                echo "Building package in ${dir}" && \
                cd "${dir}" && \
                makepkg --noconfirm -scf && \
                mv *.pkg.tar.zst /data/repo/ && \
                cd .. ;
              fi
            done
          '
          
          echo "--- Creating local repository database ---"
          repo-add /data/repo/devos-repo.db.tar.gz /data/repo/*.pkg.tar.zst

          echo "--- Building ISO Image ---"
          cd /data/archiso
          mkarchiso -v -w /tmp/archiso-work -o /data/out .

      - name: Restore workspace ownership
        run: sudo chown -R $(whoami):$(whoami) .

      - name: Upload ISO as artifact
        uses: actions/upload-artifact@v4
        with:
          name: DevOS-ISO
          path: archiso/out/devos-*.iso